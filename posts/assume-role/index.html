<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>How to assume ec2 instance role | notes to self</title>



<link href="http://kerma.codes/index.xml" rel="alternate" type="application/rss+xml" title="notes to self" />

<link rel="stylesheet" href="/css/style.css"/><link rel='stylesheet' href='http://kerma.codes/css/custom.css'><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>
<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="http://kerma.codes">
          <h1 class="title is-4">notes to self</h1>
        </a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile"></nav>
      </div>
    </nav>

    <nav class="nav">
      

      
    </nav>

  </div>
</section>
<section class="section">
  <div class="container">
    <div class="subtitle tags is-6 is-pulled-right">
      
      
<a class="subtitle is-6" href="/tags/aws">#aws</a>



      
    </div>
    <h2 class="subtitle is-6">February 9, 2017</h2>
    <h1 class="title">How to assume ec2 instance role</h1>
    
    <div class="content">
      <p>I just spent two hours of my life trying to get AssumeRole working. And that was not the first time. So I hope this article saves someone elses time or reminds me again in six months how to do this properly.</p>

<h1 id="assume-what">Assume what?</h1>

<p>To work with AWS resources you can create a user, assing roles to it or use inline policies attached to that user. This works if you have couple of users and few resources to work with. But once your application count reaches two digits it may become more complicated.</p>

<p>You should rotate access keys often, make sure that all users have correct permissions and that they couldn&rsquo;t access parts of your account that you wish to keep secured. Add some developers, multiple environments and access levels to the mix and all this becomes little annoying to manage.</p>

<p>But each ec2 instance has a role since it was created. You might as well manage this roles access and forget about managing access keys manually. This sounds like a nice solution, until you start to think about developing and testing your application locally. You localhost does not have that role.</p>

<p>This is where AWS Security Token Service comes into play.</p>

<h1 id="an-example">An example</h1>

<p>Start by looking up your role you like to assume and note down it&rsquo;s ARN (<strong>arn:aws:iam::123456789:role/ec2-my-server</strong>)</p>

<p>Create a user for development environment (IAM) and note it&rsquo;s ARN (something like <strong>arn:aws:iam::123456789:user/developer</strong>).</p>

<p>Add an inline policy, use generator or paste in something like this:</p>

<pre><code>{
    &quot;Version&quot;: &quot;2012-10-17&quot;,
    &quot;Statement&quot;: [
        {
            &quot;Sid&quot;: &quot;Stmt1486663415000&quot;,
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Action&quot;: [
                &quot;sts:AssumeRole&quot;
            ],
            &quot;Resource&quot;: [
                &quot;arn:aws:iam::123456789:role/ec2-my-server&quot;
            ]
        }
    ]
}
</code></pre>

<p>Now the next part is the tricky one. I tested the policy with Policy Simulator but could not figure out why I see the following using awscli:</p>

<pre><code>$ aws sts assume-role --role-arn arn:aws:iam::123456789:role/ec2-my-server --role-session-name testSession1

A client error (AccessDenied) occurred when calling the AssumeRole operation: User: arn:aws:iam::123456789:user/developer is not authorized to perform: sts:AssumeRole on resource: arn:aws:iam::123456789:role/ec2-my-server
</code></pre>

<p>The problem is in missing Trust Relationship. Check again your server role and add your user ARN under Edit Trust Relationships:</p>

<pre><code>{
    &quot;Version&quot;: &quot;2008-10-17&quot;,
    &quot;Statement&quot;: [
        {
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Principal&quot;: {
                &quot;Service&quot;: &quot;ec2.amazonaws.com&quot;,
                &quot;AWS&quot;: &quot;arn:aws:iam::123456789:user/developer&quot;
            },
            &quot;Action&quot;: &quot;sts:AssumeRole&quot;
        }
    ]
}
</code></pre>

<p>Voil√†.</p>
      
    </div>
    
  </div>
</section>

<section class="section">
  <div class="container">
    <aside><div id="disqus_thread"></div></aside>
  
    <div id="show_comments"><a id="load_comments">Comments</a></div>
  
    <script type="text/javascript">
      var disqus_shortname = 'kerma';
      function disqus() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }
  
      
      var hash = window.location.hash.substr(1);
      if ((hash.length > 8) && (hash.substring(0, 8) === "comment-")) {
        disqus();
        document.getElementById("show_comments").style.display = "none";
      } else {
        document.getElementById('load_comments').onclick = function() {
          disqus();
          document.getElementById("show_comments").style.display = "none";
        };
      }
  

    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <p></p>
    
      <p>Powered by <a href="https://gohugo.io/">Hugo</a> &amp; <a href="https://github.com/ribice/kiss">Kiss</a>.</p>
    
  </div>
</section>



</body>
</html>

